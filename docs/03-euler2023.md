# Attack #02: Euler Finance Exploit

## Overview

This document describes the simulation of the Euler Finance exploit that occurred in March 2023, resulting in the theft of approximately $196M from the Euler protocol.

**Reference**: [Cyfrin Blog - How Did the Euler Finance Hack Happen?](https://www.cyfrin.io/blog/how-did-the-euler-finance-hack-happen-hack-analysis)

## Attack Summary

- **Date**: March 2023
- **Amount Lost**: ~$196M
- **Affected Protocol**: Euler Finance lending protocol
- **Attack Type**: Soft liquidation exploit via `donateToReserves`
- **Root Cause**: Missing health score check in `donateToReserves()` function

## Vulnerability Details

### The Vulnerability

The vulnerability lies in the `EToken.donateToReserves()` function, which allows users to donate eTokens to protocol reserves without checking the account's health score. This enables attackers to:

1. Become undercollateralized by donating collateral
2. Trigger soft liquidation (no liquidation penalty)
3. Liquidate themselves at a discount
4. Extract profit from the protocol

### Attack Flow

The attack uses a flash loan and two contracts (`Violator` and `Liquidator`):

**Step 1: Flash Loan**
- Borrow 30M DAI from Aave

**Step 2: Violator Contract - Become Insolvent**
1. Deposit 20M DAI as collateral
2. Mint 200M eDAI (first borrow, 10x leverage)
3. Repay 10M DAI to improve health score temporarily
4. Mint 200M eDAI again (second borrow, layered leverage)
5. Donate 100M eDAI to reserves (vulnerability: no health check)
6. Health score drops below 1.0, account becomes liquidatable

**Step 3: Liquidator Contract - Extract Profit**
1. Check liquidation opportunity (health score, repay/yield amounts)
2. Execute liquidation (repay debt, receive collateral at discount)
3. Withdraw remaining funds from Euler protocol
4. Transfer profit back to attacker

**Step 4: Repay Flash Loan**
- Repay Aave flash loan with profit
- Attacker keeps ~8.87M DAI profit

### Key Code Vulnerability

The vulnerable code in `EToken.donateToReserves()`:

```solidity
function donateToReserves(uint256 subAccountId, uint256 amount) external {
    // ❌ Missing validation: No health score check before donation
    // User can donate even if it makes them undercollateralized
    _donateToReserves(subAccountId, amount);
}
```

### Why This Breaks the Protocol

1. **No Health Check**: Users can donate collateral even when it makes them insolvent
2. **Soft Liquidation**: Under-collateralized accounts can be liquidated without penalty
3. **Layered Leverage**: Multiple borrows allow building large positions
4. **Self-Liquidation**: Attacker liquidates themselves at discount for profit

## The Fix

### Patched Implementation

The fix adds health score validation before allowing donations:

```solidity
function donateToReserves(uint256 subAccountId, uint256 amount) external {
    // ✅ FIX: Check health score before allowing donation
    require(
        _getHealthScore(subAccountId) >= 1.0e18,
        "EToken: donation would make account undercollateralized"
    );
    _donateToReserves(subAccountId, amount);
}
```

### What Changed

1. **Health Score Check**: Donations are blocked if they would make account undercollateralized
2. **Invariant Protection**: Ensures accounts maintain sufficient collateralization
3. **Prevents Exploit**: Attackers cannot intentionally become insolvent through donations

## Simulation Files

### Attack Contracts
- **File**: `src/euler2023/EulerExploit.sol`
- **Violator Contract**: Executes exploit by becoming insolvent
- **Liquidator Contract**: Liquidates violator and extracts profit

### Tests
- **File**: `test/euler2023/EulerExploit.t.sol`
  - Tests the complete exploit flow using flash loan
  - Verifies profit extraction from Euler protocol

## Running the Simulation

### Prerequisites
- Fork at block 16817995 (one block before attack)
- Archive node RPC URL required
- Aave V2 and Euler protocol addresses

### Test Exploit
```bash
forge test --match-path test/euler2023/EulerExploit.t.sol -vvv
```

## Key Learnings

1. **Health Score Validation**: Critical operations must check account health before execution
2. **Donation Functions**: Functions that modify collateral must validate state
3. **Soft Liquidation**: Liquidation mechanisms must account for self-liquidation attacks
4. **Layered Leverage**: Multiple borrows can create complex attack vectors
5. **Flash Loan Integration**: Flash loans enable complex multi-step exploits

## References

- [Cyfrin Blog - Euler Finance Hack Analysis](https://www.cyfrin.io/blog/how-did-the-euler-finance-hack-happen-hack-analysis)
- [Euler Protocol](https://www.euler.finance/)
- [Euler Exploit Transaction](https://etherscan.io/tx/...)

