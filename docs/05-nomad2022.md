# Attack #05: Nomad Bridge Exploit

## Overview

This document describes the simulation of the Nomad Bridge exploit that occurred in August 2022, resulting in the theft of approximately $152M-$190M from the Nomad cross-chain bridge protocol.

**Reference**: [Nomad Blog - Nomad Bridge Hack Root Cause Analysis](https://medium.com/nomad-xyz-blog/nomad-bridge-hack-root-cause-analysis-875ad2e5aacd)

## Attack Summary

- **Date**: August 2022
- **Amount Lost**: ~$152M-$190M US$
- **Affected Contract**: Replica contract (0x5d94309e5a0090b165fa4181519701637b6daeba)
- **Attack Type**: Message validation bypass exploit
- **Root Cause**: Zero hash (`bytes32(0)`) treated as valid committed root due to initialization bug

## Vulnerability Details

### The Vulnerability

The vulnerability lies in the `Replica` contract's `process()` function, which validates messages using the `acceptableRoot()` check. During a routine upgrade, the contract was mistakenly initialized with the zero hash (`bytes32(0)`) set as an acceptable root. This critical bug allowed any message to bypass proof requirements:

1. The `confirmAt` mapping was initialized with `confirmAt[bytes32(0)] = 1`
2. When checking `acceptableRoot(bytes32(0))`, the function returns `true` because `block.timestamp >= 1` is always true
3. Unproven messages with default zero-root status could bypass validation
4. Attackers could copy valid message payloads from Etherscan and modify recipient addresses to drain bridge funds

### Attack Flow

The attack was remarkably simple and led to a "free-for-all" where many attackers copied the exploit:

**Step 1: Identify the Vulnerability**
- Attacker discovers that the Replica contract accepts messages with zero root
- Existing successful transactions on Etherscan reveal the exploit pattern

**Step 2: Copy and Modify Payloads**
- Copy message payloads from successful exploit transactions
- Modify recipient address to attacker's address
- Keep all other message fields identical (token, amount, etc.)

**Step 3: Execute Exploit**
- Call `Replica.process()` with modified payload
- The zero-root check passes because `confirmAt[bytes32(0)] == 1`
- Bridge processes the message and transfers tokens to attacker
- Repeat for all tokens available on the bridge

**Step 4: Mass Exploitation**
- Multiple attackers copy the same exploit code
- Many simply change recipient addresses and drain bridge funds
- Attack becomes a "copy-paste" exploit accessible to anyone

### Key Code Vulnerability

The vulnerable code in `Replica.acceptableRoot()`:

```solidity
function acceptableRoot(bytes32 _root) public view returns (bool) {
    uint256 _time = confirmAt[_root];
    if (_time == 0) {
        return false;
    }
    return block.timestamp >= _time;
}
```

**The Problem:**
- During initialization, `confirmAt[bytes32(0)]` was set to `1`
- For any unproven message, `messages[_messageHash]` defaults to `bytes32(0)`
- `acceptableRoot(bytes32(0))` returns `true` because `block.timestamp >= 1` is always true
- This allows unproven messages to bypass validation

**The Check in `process()`:**
```solidity
require(acceptableRoot(messages[_messageHash]), "!proven");
```

Since `messages[_messageHash]` maps to `bytes32(0)` for unproven messages, and the zero root was initialized as acceptable, this check always passes.

### Why This Breaks the Bridge

1. **Zero Root Initialization**: The upgrade mistakenly initialized the zero hash as an acceptable root
2. **Default Mapping Behavior**: Unproven messages default to `bytes32(0)` in the `messages` mapping
3. **Bypass Proof Requirements**: Messages don't need merkle proofs to be processed
4. **Copy-Paste Exploit**: Attackers can copy payloads from Etherscan and modify recipient addresses
5. **Mass Drainage**: Multiple attackers drain bridge funds simultaneously

## The Fix

### Post-Exploit Actions

After the exploit was discovered:

1. **Immediate Mitigation**: Nomad unenrolled Replicas from Nomad Bridge and Governance contracts to prevent processing of fraudulent messages
2. **Bridge GUI Disabled**: Public Bridge GUI was disabled to prevent further exploitation
3. **System Restart**: Full fix required system restart and proper initialization
4. **User Warning**: Users were advised not to bridge until full fix was implemented

### Proper Fix Implementation

The fix requires proper initialization that does not treat zero hash as valid:

```solidity
function acceptableRoot(bytes32 _root) public view returns (bool) {
    // âœ… FIX: Explicitly reject zero root
    require(_root != bytes32(0), "Zero root not allowed");
    
    uint256 _time = confirmAt[_root];
    if (_time == 0) {
        return false;
    }
    return block.timestamp >= _time;
}
```

### What Changed

1. **Zero Root Rejection**: Explicitly reject `bytes32(0)` as a valid root
2. **Proper Initialization**: Ensure zero hash is never set as acceptable during initialization
3. **Message Validation**: All messages must have valid merkle proofs before processing
4. **Prevents Exploit**: Attackers cannot bypass proof requirements using zero root

## Simulation Files

### Attack Contract
- **File**: `src/nomad2022/NomadExploit.sol`
- **Purpose**: Contains `Attacker` contract that exploits the zero-root vulnerability
- **Key Functions**: `attack()` - iterates through tokens and exploits bridge, `genPayload()` - generates message payloads

### Tests
- **File**: `test/nomad2022/Nomad2022Exploit.t.sol`
  - Tests the exploit against vulnerable Nomad Replica contract
  - Verifies tokens can be drained without valid proofs

## Running the Simulation

### Prerequisites
- Fork at block 15259100 (one block before attack)
- Archive node RPC URL required
- Nomad Replica and Bridge Router addresses

### Test Exploit
```bash
forge test --match-path test/nomad2022/Nomad2022Exploit.t.sol -vvv
```

## Key Learnings

1. **Initialization Critical**: Contract initialization must be carefully audited, especially for upgradeable contracts
2. **Zero Values Dangerous**: Default zero values in mappings can create unexpected vulnerabilities
3. **Proof Validation**: Cross-chain message validation must strictly enforce proof requirements
4. **Copy-Paste Attacks**: Simple exploits can be copied by many attackers, amplifying damage
5. **Upgrade Risks**: Contract upgrades introduce new attack surfaces and must be thoroughly tested
6. **Public Transaction Data**: Attackers can learn from successful exploit transactions on-chain

## Contract Addresses

- **Nomad BridgeRouter Contract (Proxy)**: [0x88a69b4e698a4b090df6cf5bd7b2d47325ad30a3](https://etherscan.io/address/0x88a69b4e698a4b090df6cf5bd7b2d47325ad30a3)
- **Nomad BridgeRouter Contract (Logic)**: [0x15fda9f60310d09fea54e3c99d1197dff5107248](https://etherscan.io/address/0x15fda9f60310d09fea54e3c99d1197dff5107248)
- **Nomad Replica Contract (Proxy)**: [0x5d94309e5a0090b165fa4181519701637b6daeba](https://etherscan.io/address/0x5d94309e5a0090b165fa4181519701637b6daeba)
- **Nomad Replica Contract (Logic - Vulnerable)**: [0xb92336759618f55bd0f8313bd843604592e27bd8](https://etherscan.io/address/0xb92336759618f55bd0f8313bd843604592e27bd8)

## Example Transactions

- **Replica contract mistakenly initialized**: [0x53fd92771d2084a9bf39a6477015ef53b7f116c79d98a21be723d06d79024cad](https://etherscan.io/tx/0x53fd92771d2084a9bf39a6477015ef53b7f116c79d98a21be723d06d79024cad)
- **Attacker send 0.01 WBTC to NomadBridge**: [0xed26708a7335116bdb0673f32ace7c2f329fe3cd349e200447210f1721f335f0](https://etherscan.io/tx/0xed26708a7335116bdb0673f32ace7c2f329fe3cd349e200447210f1721f335f0)
- **NomadBridge Process 100 WBTC to Attacker**: [0xa5fe9d044e4f3e5aa5bc4c0709333cd2190cba0f4e7f16bcf73f49f83e4a5460](https://etherscan.io/tx/0xa5fe9d044e4f3e5aa5bc4c0709333cd2190cba0f4e7f16bcf73f49f83e4a5460)

## References

- [Nomad Blog - Root Cause Analysis](https://medium.com/nomad-xyz-blog/nomad-bridge-hack-root-cause-analysis-875ad2e5aacd)
- [NomadBridge Audit Report](https://github.com/nomad-xyz/docs/blob/1ff0c55dba2a842c811468c57793ff9a6542ef0f/docs/public/Nomad-Audit.pdf)
- [samczsun Analysis](https://twitter.com/samczsun/status/1554252024723546112)
- [Paradigm Engineering Analysis](https://twitter.com/paradigmeng420/status/1554249610574450688)
- [0xfoobar Analysis](https://twitter.com/0xfoobar/status/1554269062653411334)
- [CertiK Post-Mortem](https://www.certik.com/resources/blog/28fMavD63CpZJOKOjb9DX3-nomad-bridge-exploit-incident-analysis)
- [BlockSec Analysis](https://twitter.com/BlockSecTeam/status/1554335271964987395)
